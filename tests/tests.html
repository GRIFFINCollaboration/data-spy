<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Data Spy Testing</title>
        <link rel="stylesheet" href="../css/qunit.css">
    </head>
    <body>
        <div id="qunit"></div>
        <div id="qunit-fixture"></div>
        <script src="../scripts/qunit.js"></script>
        <script src='../scripts/parse.js' type="text/javascript"></script>

        <script>
            //////////////////////////////////////////////////////
            // GRIFFIN parser testing
            //////////////////////////////////////////////////////

            QUnit.module('core GRIFFIN parser', {
                "setup": function(){
                    parser = new GRIFFINparser;
                    data = [
                        0x88B67C80,
                        0x00850F81,
                        0x56007C84,
                        0x900461FF,
                        0xA074A998,
                        0xB074A998
                    ];
                },

                "teardown": function(){
                    return 0;
                }
            });

            QUnit.test("typeI", function( assert ) {
                unpacked = {};
                parser.parsers[1](data[0], unpacked);

                assert.equal(unpacked.packetType, 8, 'type I words always begin with packet type == 0x8.');
                assert.equal(unpacked.pileUpType, '3 hits', '0x88B67C80 has three hits piled up.');
                assert.equal(unpacked.dataType, 'GRIF-16', '0x88B67C80 is from a GRIF-16.');
                assert.equal(unpacked.numFilterPatterns, 3, '0x88B67C80 has three filter words.');
                assert.equal(unpacked.masterChan, 6, '0x88B67C80 is on master channel 8.');
                assert.equal(unpacked.slaveChan, 7, '0x88B67C80 is on slave channel 7.');
                assert.equal(unpacked.collectorChan, 200, '0x88B67C80 is on collector channel 200.');
                assert.equal(unpacked.detType, 'HPGe Low Gain', '0x88B67C80 is from a low gain HPGe detector.')
            });

            QUnit.test("typeII", function( assert ){
                unpacked = {};
                parser.parsers[2](data[1], unpacked);

                assert.equal(unpacked.typeIIhead, 0, 'type II head is always 0.');
                assert.equal(unpacked.masterFilterPatternsPassed, 'Passed filters 1, 3, 8.', '0x00850F81 indicates filters 1, 3 and 8 were passed.');
                assert.equal(unpacked.PPGpattern, 3969);

            }); 

            QUnit.test("typeIII", function( assert ){
                unpacked = {};
                parser.parsers[3](data[2], unpacked);

                assert.equal(unpacked.typeIIIhead, 0, 'type III head is always 0.');
                assert.equal(unpacked.masterFilterID, 1442872452);

            }); 

            QUnit.test("typeIV", function( assert ){
                unpacked = {};
                parser.parsers[4](data[3], unpacked);

                assert.equal(unpacked.typeIVPacketType, 9, 'type IV packet type is always 9.');
                assert.equal(unpacked.channelTriggerID, 287231);

            }); 

            QUnit.test("typeV", function( assert ){
                unpacked = {};
                parser.parsers[5](data[4], unpacked);

                assert.equal(unpacked.typeVPacketType, 0xA, 'type V packet type is always 0xA.');
                assert.equal(unpacked.timestampLowBits, 7645592);

            }); 

            QUnit.test("typeVI", function( assert ){
                unpacked = {};
                parser.parsers[6](data[5], unpacked);

                assert.equal(unpacked.typeVIPacketType, 0xB, 'type VI packet type is always 0xB.');
                assert.equal(unpacked.deadtime, '4660 ns', '0xB074A998 corresponds to a deadtime of 466 ns.');
                assert.equal(unpacked.timestampHighBits, 10648);                

            }); 

            // QUnit.test("typeII", function( assert ){
            //     unpacked = {};
            //     parser.parsers[2](data[1], unpacked);

            // }); 

            // QUnit.test("typeII", function( assert ){
            //     unpacked = {};
            //     parser.parsers[2](data[1], unpacked);

            // }); 

            // QUnit.test("typeII", function( assert ){
            //     unpacked = {};
            //     parser.parsers[2](data[1], unpacked);

            // }); 

            // QUnit.test("typeII", function( assert ){
            //     unpacked = {};
            //     parser.parsers[2](data[1], unpacked);

            // }); 

            // QUnit.test("typeII", function( assert ){
            //     unpacked = {};
            //     parser.parsers[2](data[1], unpacked);

            // }); 

            // QUnit.test("typeII", function( assert ){
            //     unpacked = {};
            //     parser.parsers[2](data[1], unpacked);

            // }); 

            // QUnit.test("typeII", function( assert ){
            //     unpacked = {};
            //     parser.parsers[2](data[1], unpacked);

            // }); 


            QUnit.test("post-processing", function ( assert ){
                    unpacked = {};
                    parser.parsers[5](data[4], unpacked);
                    parser.parsers[6](data[5], unpacked);

                    parser.reconstructTimestamp(unpacked)

                    assert.equal(unpacked.timestamp, 2858308381080)
            });

        </script>
      </body>
</html>