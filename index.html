<html>
    <head>
        <title>GRIFFIN Data Spy</title>

        <script src="scripts/jquery1-11-3.min.js" type="text/javascript"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
        <script src="scripts/bootstrap3-3-5.min.js" type="text/javascript"></script>
        <script src="scripts/plotly-latest.min.js"></script>

        <script src='scripts/mustache.js' type="text/javascript"></script>

        <script src='scripts/data-spy.js' type="text/javascript"></script>
        <script src='scripts/parse.js' type="text/javascript"></script>
        <link rel="stylesheet" href="css/data-spy.css">
    </head>

    <body>

        <div class='branding header'>
            <div class='col-md-1'>
                <img src='img/logo.gif'></img>
            </div>
            <div class='col-md-11'>
                <h1>GRIFFIN Data Spy</h1>
            </div>
        </div>

        <div class='col-md-8 col-md-offset-2'>
            <button id='showG16fragment' onclick='manageView("G16fragment")' type="button" class="btn btn-primary btn-lg">GRIF-16 Fragment</button>
            <button id='showG16scalar' onclick='manageView("G16scalar")' type="button" class="btn btn-primary btn-lg">GRIF-16 Scalar</button>
            <button id='showG4Gfragment' onclick='manageView("G4Gfragment")' type="button" class="btn btn-primary btn-lg">GRIF-4G Fragment</button>
            <button id='showPPG' onclick='manageView("PPG")' type="button" class="btn btn-primary btn-lg">PPG Event</button>
        </div>

        <div id='G16fragment'>
            <div class='col-md-8 col-md-offset-2'>
                <h2>GRIF-16 Event Fragment</h2>
            </div>
            <div id='warningsDiv' class='col-md-8 col-md-offset-2 warnings'></div>
            <div class='col-md-4 col-md-offset-2' id='leftG16fragment'></div>
            <div class='col-md-4' id='rightG16fragment'></div>
            <div class='sectionWrapper'>
                <div class='col-md-4 col-md-offset-2'>
                    <div class='box'>
                        <h2>Reconstructed Values</h2>
                        <ul>
                            <li id='grif16fragmentTimestamp'></li>
                            <li id='grif16fragmentIntegrationLength'></li>
                        </ul>
                    </div>

                    <div class='box'>
                        <h2>Raw Event</h2>
                        <ul class='raw' id='rawGRIF16fragment'></ul>
                    </div>
                </div>
                <div class='col-md-4 box' id='grif16waveformWrap'>
                    <h2>GRIF-16 Fragment Waveform</h2>
                    <div id='waveformPlot'></div>
                </div>
            </div>

        </div>
        <div id='G16scalar' class='hidden'>
            <div class='col-md-8 col-md-offset-2'>
                <h2>GRIF-16 Scalar</h2>
            </div>
        </div>
        <div id='G4Gfragment' class='hidden'>
            <div class='col-md-8 col-md-offset-2'>
                <h2>GRIF-4G Fragment</h2>
            </div>
        </div>
        <div id='PPG' class='hidden'>
            <div class='col-md-8 col-md-offset-2'>
                <h2>PPG Events</h2>
            </div>
        </div>

        <!--Notes & references-->
        <div id='references' class='sectionWrapper box'>
            <div>
                <h2>References</h2>
                <h3>GRIFFIN</h3>
                <ul>
                    <li><a href=''>GRIFFIN Data Format Specification</a></li>
                </ul>

                <h3>Software</h3>
                <ul>
                    <li>Figures: <a href='https://plot.ly/'>Plotly.js 1.1.1</a></li>
                    <li>Unit testing: <a href='http://qunitjs.com/'>QUnit 1.19.0</a>, The jQuery Foundation</li>
                    <li>CSS: <a href='http://getbootstrap.com/'>Twitter Bootstrap v3.3.5</a>, Twitter</li>
                </ul>
            </div>
        </div>

        <div id='footer' class='branding footer'>
            <h3>Built at TRIUMF</h3>
            <div class='col-md-4'>
                <div>&copy; 2015 GRIFFIN Collaboration</div>
                <a href='https://github.com/GRIFFINCollaboration/data-spy'>Source on GitHub</a>
            </div>
            <div class='col-md-8'></div>
        </div>

        <script>

            var i,
                grif16fragmentWords = defineGRIF16fragmentTableStructure(),
                ODBrequest = 'http://grsmid00.triumf.ca:8081/?cmd=jcopy&odb0=/Runinfo/Run number&encoding=json-p-nokeys&callback=parseODB',
                templates = [
                    'parsingTable',
                    'warningsList'
                ]
            dataStore = {
                'currentViewID': 'G16fragment',
                'GRIF16fragmentWordFlags' : {}
            };

            //fetch the templates, then set up html, then fetch data from the ODB, then parse it and sort it into the table
            Promise.all(templates.map(promisePartial)
                ).then(
                    function(partials){
                        var i;

                        //save partials for later
                        dataStore.partials = {};
                        for(i=0; i<templates.length; i++){
                            dataStore.partials[templates[i]] = partials[i];
                        }

                        //set up html
                        //grif 16 fragments
                        document.getElementById('leftG16fragment').innerHTML = Mustache.to_html(
                                partials[0],
                                {
                                    "words" : grif16fragmentWords.slice(0,5)
                                }
                            )

                        document.getElementById('rightG16fragment').innerHTML = Mustache.to_html(
                                partials[0],
                                {
                                    "words" : grif16fragmentWords.slice(5)
                                }
                            )

                        //grif 16 scalar

                        //grif 4g fragments

                        //ppg
                    }
                ).then(
                    function(){
                        //fetch most recent events
                        //promiseScript(ODBrequest)

                        //testing implementation until events are available in odb
                        var testingData = {
                            'grif16fragment': [
                                0x8EA67C80,
                                0xD0850F81,
                                0x1a047C84,
                                0x000461FF,
                                0x9074A998,
                                0xA074A998,
                                0xB00461FF,

                                0xC0000001,
                                0xC0000002,
                                0xC0000003,
                                0xC0000004,

                                0x057715CC,
                                0x0074A998,
                                0xE874A998
                            ]
                        }

                        parseODB([testingData.grif16fragment, null, null, null]);
                    }
                )




        </script>

    </body>
</html>